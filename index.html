<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>King Dev Academy - Multiplayer Pong</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --neon-blue: #00d2ff; --neon-pink: #ff007f; }
        body { background: #0a0a0a; color: #fff; font-family: 'Courier New', monospace; margin: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; touch-action: none; }
        #menu { background: rgba(0,0,0,0.9); padding: 30px; border: 2px solid var(--neon-blue); text-align: center; border-radius: 10px; z-index: 100; }
        input { padding: 12px; border: 1px solid var(--neon-blue); background: #111; color: white; margin: 10px; width: 250px; text-align: center; }
        button { background: var(--neon-blue); color: black; border: none; padding: 12px 25px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        button:hover { background: white; }
        canvas { border: 3px solid #333; box-shadow: 0 0 20px rgba(0,0,0,0.5); display: none; background: #000; max-width: 95vw; max-height: 80vh; }
        #idDisplay { color: var(--neon-pink); font-size: 1.2em; word-break: break-all; }
    </style>
</head>
<body>

    <div id="menu">
        <h1 style="color:var(--neon-blue)">KING PONG</h1>
        <p>SEU ID: <br><span id="idDisplay">CONECTANDO...</span></p>
        <input type="text" id="targetID" placeholder="Cole o ID do seu amigo">
        <br>
        <button onclick="sendInvite()">Convidar Amigo</button>
        <p style="font-size: 12px; color: #666; margin-top: 20px;">King Dev Academy</p>
    </div>

    <canvas id="pong" width="800" height="500"></canvas>

    <script>
        const socket = io();
        const canvas = document.getElementById("pong");
        const ctx = canvas.getContext("2d");
        
        let myID, currentRoom, isHost = false;
        const ball = { x: 400, y: 250, r: 8, vX: 5, vY: 5 };
        const p1 = { y: 210, h: 80, w: 12, score: 0 }; // Local
        const p2 = { y: 210, h: 80, w: 12, score: 0 }; // Remoto

        socket.on('myID', id => {
            myID = id;
            document.getElementById('idDisplay').innerText = id;
        });

        function sendInvite() {
            const tid = document.getElementById('targetID').value;
            if(tid) {
                socket.emit('invitePlayer', tid);
                alert("Convite enviado! Aguarde seu amigo aceitar.");
            }
        }

        socket.on('receiveInvite', (fromID) => {
            if(confirm("Jogador " + fromID.substring(0,5) + "... te convidou! Aceitar?")) {
                socket.emit('acceptInvite', fromID);
            }
        });

        socket.on('gameStart', (data) => {
            currentRoom = data.room;
            isHost = (myID === data.host);
            document.getElementById('menu').style.display = 'none';
            canvas.style.display = 'block';
            gameLoop();
        });

        // Controles (Mouse/Touch)
        const handleMove = (e) => {
            const rect = canvas.getBoundingClientRect();
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const y = (clientY - rect.top) * (500 / rect.height) - p1.h/2;
            p1.y = y;
            socket.emit('updatePos', { room: currentRoom, y: p1.y, player: myID });
        };

        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); }, {passive:false});

        socket.on('opponentPos', (data) => {
            p2.y = data.y;
        });

        socket.on('ballData', (data) => {
            if(!isHost) {
                ball.x = data.x; ball.y = data.y;
                p1.score = data.p1Score; p2.score = data.p2Score;
            }
        });

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            if(isHost) {
                ball.x += ball.vX; ball.y += ball.vY;
                if(ball.y < 0 || ball.y > 500) ball.vY *= -1;

                // Colisão simples
                if(ball.x < 30 && ball.y > p1.y && ball.y < p1.y + p1.h) ball.vX *= -1.1;
                if(ball.x > 770 && ball.y > p2.y && ball.y < p2.y + p2.h) ball.vX *= -1.1;

                if(ball.x < 0) { p2.score++; resetBall(); }
                if(ball.x > 800) { p1.score++; resetBall(); }

                socket.emit('ballSync', { room: currentRoom, x: ball.x, y: ball.y, p1Score: p1.score, p2Score: p2.score });
            }
        }

        function resetBall() {
            ball.x = 400; ball.y = 250; ball.vX = 5; ball.vY = 5;
        }

        function draw() {
            ctx.fillStyle = "#000"; ctx.fillRect(0,0, 800, 500);
            
            // Rede
            ctx.strokeStyle = "#333"; ctx.setLineDash([10,10]);
            ctx.beginPath(); ctx.moveTo(400,0); ctx.lineTo(400,500); ctx.stroke();

            // Placar
            ctx.fillStyle = "#fff"; ctx.font = "30px Arial";
            ctx.fillText(isHost ? p1.score : p2.score, 350, 50);
            ctx.fillText(isHost ? p2.score : p1.score, 430, 50);

            // Raquetes (A minha é sempre azul)
            ctx.fillStyle = var(--neon-blue);
            ctx.fillRect(10, p1.y, p1.w, p1.h);
            ctx.fillStyle = var(--neon-pink);
            ctx.fillRect(778, p2.y, p2.w, p2.h);

            // Bola
            ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI*2); ctx.fill();
        }
    </script>
</body>
</html>
